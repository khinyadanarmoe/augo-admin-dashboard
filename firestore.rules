rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
  	function isAdmin(){
    	return request.auth != null && request.auth.token.admin == true;
    }
    
    function isSignedIn() {
      return request.auth != null 
        && (!exists(/databases/$(database)/documents/users/$(request.auth.uid))
            || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status != "banned");
    }
    
    function isAUEmail() {
      return isSignedIn() && request.auth.token.email.matches('.*@au[.]edu$');
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isReactionCountUpdateOnly() {
  		return isAUEmail()
    	&& request.resource.data.diff(resource.data).changedKeys().hasOnly(["likeCount", "dislikeCount"])
    	&& request.resource.data.likeCount is int
    	&& request.resource.data.dislikeCount is int
    	&& request.resource.data.likeCount >= 0
    	&& request.resource.data.dislikeCount >= 0
    	&& (request.resource.data.likeCount - resource.data.likeCount) >= -1
    	&& (request.resource.data.likeCount - resource.data.likeCount) <= 1
    	&& (request.resource.data.dislikeCount - resource.data.dislikeCount) >= -1
    	&& (request.resource.data.dislikeCount - resource.data.dislikeCount) <= 1;
		}
    
    function isReportCountUpdateOnly() {
      return isAUEmail()
      && request.resource.data.diff(resource.data).changedKeys().hasOnly(["reportCount"])
      && request.resource.data.reportCount is int
      && request.resource.data.reportCount >= 0
      && (request.resource.data.reportCount - resource.data.reportCount) == 1;
    }

    // Helper function to check if user is announcer
    function isAnnouncer() {
      return isSignedIn() && request.auth.token.announcer == true;
    }
    
		match /users/{userId} {
  		allow read: if (request.auth != null && request.auth.uid == userId) || isAUEmail() || isAdmin();
  		allow create: if request.auth != null && request.auth.token.email.matches('.*@au[.]edu$') && request.auth.uid == userId;
  		allow update: if isOwner(userId) || isAdmin();
  		allow delete: if false;
		}
    
		match /posts/{postId} {
  		allow read: if isSignedIn();
  		allow create: if isAUEmail() 
        && request.resource.data.userId == request.auth.uid
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status != "suspended";
  		allow update: if isAdmin()
                		|| (isAUEmail() && resource.data.userId == request.auth.uid)
                		|| isReactionCountUpdateOnly()
                		|| isReportCountUpdateOnly();
  		allow delete: if isAdmin() || (isAUEmail() && resource.data.userId == request.auth.uid);
		}
    
    match /reports/{reportId} {
      allow create: if isAUEmail();
      allow read, update, delete: if isAdmin();
    }
    
    match /announcements/{announcementId} {
      // Use custom claim instead of exists() for better performance
      allow read: if isSignedIn();
    	allow read, create, update: if isAdmin() || isAnnouncer() || isAUEmail();
      allow delete: if isAdmin();
    }
    
		match /announcement_reactions/{reactionId} {
  		allow read: if isSignedIn();
  		allow create, update, delete: if isSignedIn()
    	&& reactionId.matches('^' + request.auth.uid + '_.*$');
		}

    match /user_reactions/{reactionId} {
  		allow read: if isAUEmail() || isAnnouncer() || isAdmin();
  		allow create, update: if isAUEmail() && reactionId.matches('^' + request.auth.uid + '_.*$');
  		allow delete: if isAUEmail() && reactionId.matches('^' + request.auth.uid + '_.*$') || isAdmin();
		}

    match /admin_configuration/{document=**} {
      allow read: if request.auth != null; // or your AU-email rule
  		allow read, write: if isAdmin();
		}

		match /configuration_logs/{document=**} {
  		allow read: if isAdmin();
  		allow create: if isAdmin();
  		allow update, delete: if false;
		}

		match /admin_notifications/{document=**} {
  		allow read: if isAdmin();
  		allow create: if isSignedIn();
  		allow update: if isAdmin();
  		allow delete: if false;
		}
    
    match /user_notifications/{notificationId} {
      // Allow users to read their own notifications (works with queries/listeners)
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
      // Allow users to update their own notifications (mark as read)
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    match /announcers/{announcerId} {
    	allow read: if (isSignedIn() && request.auth.uid == announcerId) || isAdmin();
      allow write: if isAdmin();
    }
    
		match /affiliations/{affiliationId} {
 	 		allow read: if true;
  		allow write: if isAdmin();
		}
  
  // Firestore: add near other match blocks
		match /ar_spawns/{spawnId} {
  		allow read: if isAUEmail() || isAnnouncer() || isAdmin();
  		allow create, update, delete: if isAdmin();
		}

		match /ar_captures/{captureId} {
  		allow read: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
  		allow create: if isSignedIn()
    		&& request.resource.data.userId == request.auth.uid
    		&& request.resource.data.validated == false; // client cannot self-validate
  		allow update, delete: if isAdmin(); // backend/admin only for validation changes
		}
  }
}
